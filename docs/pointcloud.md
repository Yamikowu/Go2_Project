# 點雲掃描器 (pointcloud.py) 使用說明

## 📌 什麼是點雲 (Point Cloud)？

點雲是由**數十萬個 3D 座標點**組成的「立體掃描圖」，就像把房間變成一堆彩色沙子，每一顆沙子都有自己的位置 (X, Y, Z)。

### 點雲的用途

| 應用                      | 說明                                         |
| ------------------------- | -------------------------------------------- |
| **建立地圖**        | 機器人需要「記住」環境才能導航               |
| **離線開發**        | 把檔案帶到沒有相機的電腦上測試演算法         |
| **3D 模型製作**     | 匯入 Blender、MeshLab、Unity 製作 VR/AR 場景 |
| **SLAM 演算法基礎** | 多幀點雲拼接成完整環境地圖                   |

---

## 🚀 使用方式

```bash
sudo /Users/yamiko/Documents/VsCode/Go2_Project/.venv/bin/python /Users/yamiko/Documents/VsCode/Go2_Project/camera/demo/pointcloud.py
```

> ⚠️ **必須使用 `sudo`**：macOS 需要管理員權限才能存取 USB 裝置。

---

## 🎮 操作說明

| 按鍵/動作             | 功能                     |
| --------------------- | ------------------------ |
| `s`                 | 儲存點雲為 `.ply` 檔案 |
| `q`                 | 離開程式                 |
| `r`                 | 重置 3D 視角             |
| 滑鼠左鍵拖曳 (3D視窗) | 旋轉視角                 |
| 滑鼠右鍵拖曳 (3D視窗) | 平移視角                 |
| 滾輪 (3D視窗)         | 縮放                     |

> 💡 按鍵需要在 **Point Cloud 視窗**有焦點時才有效。

---

## ⚙️ 運作原理

### 1. 深度圖轉 3D 座標

程式使用**相機內參 (Intrinsics)** 將 2D 深度圖像的每個像素轉換為 3D 空間座標：

```
X = (u - cx) × Z / fx
Y = (v - cy) × Z / fy
Z = 深度值
```

其中 `fx`, `fy` 是焦距，`cx`, `cy` 是光學中心。

### 2. 假色彩渲染

因為不使用 RGB 相機，程式用**深度值**來產生假顏色：

- 🔴 **近的物體** → 紅色
- 🔵 **遠的物體** → 藍色

### 3. 即時顯示

使用 **Open3D** 函式庫在 3D 視窗中即時渲染點雲。

---

## 🐛 開發過程中遇到的問題與解決方案

### 問題 1：3D 視窗全黑

**症狀**：2D 視窗正常顯示，但 3D 視窗全黑。

**原因**：視角沒有對準點雲位置。

**解決方案**：在程式中加入自動對焦功能：

```python
if first_update:
    vis.reset_view_point(True)
    first_update = False
```

---

### 問題 2：手的形狀上下顛倒

**症狀**：伸出手時，點雲顯示的手是倒過來的。

**原因**：RealSense 相機的座標系是 **Y 軸朝下**，而 Open3D 預設 **Y 軸朝上**。

**解決方案**：在座標轉換時翻轉 Y 軸和 X 軸：

```python
y = -(v - cy) * z / fy  # 翻轉 Y 軸
x = -x                  # 鏡像 X 軸 (像照鏡子)
```

---

### 問題 3：按鍵沒有反應

**症狀**：按 `s` 或 `q` 沒有任何反應，Mac 發出錯誤提示音。

**原因**：按鍵事件由 OpenCV 的 `waitKey()` 監聽，必須讓 **2D Preview 視窗**獲得焦點。但後來發現在 **Point Cloud 視窗**有焦點時也可以運作。

**解決方案**：點選point cloud視窗後再按按鍵。

---

## 📊 輸出說明

### 終端機輸出

```
📊 點雲點數: 276,587
```

表示目前畫面有 27 萬多個 3D 點。

### 儲存的檔案

按 `s` 後會儲存 `.ply` 檔案到當前目錄，檔名格式：`scan_YYYYMMDD_HHMMSS.ply`
